---
title: "TULip Ki67 Study"
author: |
  | Stephen Pederson
  | Dame Roma Mitchell Cancer Research Laboratories
  | Adelaide Medical School
  | University of Adelaide
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE
)
```

```{r packages}
library(tidyverse)
library(readxl)
library(scales)
library(glue)
library(magrittr)
library(pander)
library(cowplot)
library(matrixStats)
library(e1071)
library(sn)
library(zoo)
library(truncnorm)
library(parallel)
```

```{r options}
theme_set(theme_bw())
geom_mean <- function(x, ...){
  exp(mean(log(x), ...))
}
```

# Introduction

The common measurement of Ki67 data is as a percentage of cells staining +ve for Ki67.

## Power Calculations

In this study a comparison of an Aromatase Inhibitor treated arm (Letrazole) with a double-treated arm (Letrazole + Testosterone Undecanoate).
The desired reduction in Ki67 for double-treated (L+TU) samples is an additional 20% beyond that seen by Letrazole alone.

Based on the values observed in [*Long-term outcome and prognostic value of Ki67 after perioperative endocrine therapy in postmenopausal women with hormone-sensitive early breast cancer (POETIC): an open-label, multicentre, parallel-group, randomised, phase 3 trial* (The Lancet, 2020)](https://www.thelancet.com/journals/lanonc/article/PIIS1470-2045(20)30458-7/fulltext), untreated samples were simulated using a truncated normal distribution with location &mu; = 0.086 and scale %sigma; = 0.18.
Truncation points were the values 0 & 1, and this gave distributions which provided broadly similar values for median and the IQR as obtained by this study.

Whilst a non-responder rate to both compounds was simulated between 10% to 30%, it may of note that in [one early study](https://cancerres.aacrjournals.org/content/63/19/6523.long) up to 25% of patients failed to respond to Letrazole.
Given the significant advances since 2003, the non-responder range as used here was considered suitable.
However, it should be noted that as part of the simulation process some non-responders may appear to be responders just by having low Ki67 values prior to intervention.
This is relatively representative of the true data where some non-responders will not be able to be identified unless matched Ki67 values are obtained pre/post intervention.


```{r sim_data}
sim_data <- function(n0, n1, ki0 = 0.086, sigma0 = 0.18, delta1 = 0.75, delta2 = 0.2, p_non = 0.1, ...){
  
  ## Refine delta2
  delta2 <- (1+delta2)*delta1
  
  ## Given that the mean of a truncated normal is not the location parameter,
  ## we need to recalculate the location parameter such that the mean is reduced
  ## by delta as desired
  ## For alpha/beta just use the first scaled distribution as an approximation
  ## Checking has revealed these values to be relatively consistent with the 
  ## simulated reduvction in Ki67
  alpha <- -(1-delta1)*ki0/(sqrt(1-delta1)*sigma0)
  beta <- (1-(1-delta1)*ki0)/(sqrt(1-delta1)*sigma0)
  m <- (dnorm(alpha) - dnorm(beta)) / (pnorm(beta) - pnorm(alpha))
  k1 <- 1 - delta1
  k2 <- 1 - delta2
  
  ## For some scalar a^2 such that a^2*mu0 + a*m*sigma0 = k(mu0 + m*sigma0),
  ## i.e. X1 ~ N(mu0*a^2, sigma0*a)[0, 1]
  a1 <- sqrt(k1 + k1*m*sigma0/ki0 + (0.5*m*sigma0/ki0)^2) - 0.5*m*sigma0/ki0
  a2 <- sqrt(k2 + k2*m*sigma0/ki0 + (0.5*m*sigma0/ki0)^2) - 0.5*m*sigma0/ki0
  
  ## Simulate initial values
  pre <- rtruncnorm(n0, a = 0, b = 1, mean = ki0*a1^2, sd = sigma0*a1)
  post <- rtruncnorm(n1, a = 0, b = 1, mean = ki0*a2^2, sd = sigma0*a2)
  
  ## Add non-responders & resample
  non <- as.logical(rbinom(n1, 1, p_non))
  post[non] <- rtruncnorm(sum(non), a = 0, b = 1, mean = ki0, sd = sigma0)
  ## Repeat for pre
  non <- as.logical(rbinom(n1, 1, p_non))
  pre[non] <- rtruncnorm(sum(non), a = 0, b = 1, mean = ki0, sd = sigma0)
  
  ## Run the Wilcoxon test
  wilcox.test(pre, post)$p.value
}
```

```{r sim_params}
n_sim <- 1000
alpha <- 0.05
n0 <- c(20, 30, 40, 50, 60)
n1 <- c(
  n0,
  1.5*n0,
  2*n0
)
```

```{r sim_res}
sim_res <- list(
  tibble(
    n0 = rep(n0, 3),
    n1 = n1,
    p_non = 0.1
  ),
  tibble(
    n0 = rep(n0, 3),
    n1 = n1,
    p_non = 0.20
  ),
  tibble(
    n0 = rep(n0, 3),
    n1 = n1,
    p_non = 0.30
  )
) %>%
  bind_rows() %>%
  split(f = seq_len(nrow(.))) %>%
  mclapply(
    function(x){
      p <- replicate(
        n_sim,
        {
          sim_data(n0 = x$n0, n1 = x$n1, p_non = x$p_non)
        }
      )
      mutate(x, power = mean(p < alpha))
    },
    mc.cores = 6
  ) %>%
  bind_rows() %>%
  mutate(
    N = n0 + n1
  ) 
```

```{r plot_curves, fig.cap = "_Power curves for detection of an additional 20% reduction in Ki67 due to a combination treatment of L+TU in comparison to Letrazole alone. Panels represent equal samples sizes in both treatment groups (L+TU=1*L), having an extra 50% of participants in the combination group (L+TU = 1.5*L), or having double the number of particiapnts in the combined treatment group (L+TU = 2*L). Error bars indicate a 95% confidence interval around the power estimates_"}
sim_res %>% 
  mutate(
    `n1/n0` = paste0("L+TU = ", n1/n0, "*L") %>% fct_inorder(),
    se = sqrt(power*(1-power)/n_sim)
  ) %>%
  ggplot(aes(n0, power, colour = as.factor(p_non))) +
  geom_point() + 
  geom_line() +
  geom_errorbar(
    aes(ymin = power - 1.96*se, ymax = power + 1.96*se),
    width = 1
  ) +
  facet_wrap(~`n1/n0`) +
  labs(
    x = "Sample Size (Letrazole)",
    y = "Power",
    colour = "% Non-Responders"
  ) +
  theme(
    legend.position = c(0.9, 0.1)
  )
```

From the above power curves:

- *Keeping group sizes equal* requires N = 120 (n1 = 60; n2 = 60) to achieve a 90% power in the presence of 20% non-responders
- *Including an additional 50% of participants in the combined treatment group* is able to achieve a power > 90% at N = 100 (n1 = 40; n2 = 60)
- *Including double the number of participants in the combined treatment group* is able to achieve a power of 90% at N = 90 (n1 = 30; n2 = 60)

