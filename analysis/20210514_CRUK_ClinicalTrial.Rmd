---
title: "CRUK Enobosarm Clinical Trial"
author: |
  | Stephen Pederson
  | Dame Roma Mitchell Cancer Research Laboratories
  | Adelaide Medical School
  | University of Adelaide
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,
    message = FALSE,
    warning = FALSE
)
```

```{r packages}
library(tidyverse)
library(readxl)
library(zoo)
library(truncnorm)
library(parallel)
library(scales)
library(glue)
library(magrittr)
library(pander)
```

```{r options}
theme_set(theme_bw())
```


# Ki67 data

The common measurement of Ki67 data is as a percentage of cells staining +ve for Ki67.
Example data is taken from PDX samples in the Nature Medicine paper.

```{r load_ki67}
ki67_natmed <- here::here("data/41591_2020_1168_MOESM3_ESM.xlsx") %>%
    read_excel(sheet = "S1d") %>%
    setNames(
        tibble(
            names = colnames(.),
            r1 = unlist(.[1,])
        ) %>%
            mutate(
                names = str_replace_all(names, "\\.\\.\\.+", NA_character_),
                names = na.locf(names)
            ) %>%
            unite(names, names, r1, sep = " ") %>%
            pull(names) %>%
            str_remove_all(" NA$")
    ) %>%
    dplyr::slice(-1) %>%
    dplyr::filter(!str_detect(Diagnosis, "Normal"))
```

```{r plot_ki67}
ki67_natmed %>%
    dplyr::select(`Sample ID`, contains("Ki67")) %>%
    pivot_longer(
        cols = contains("E2"),
        names_to = "treat",
        values_to = "ki67"
    ) %>%
    mutate(
        treat = str_remove_all(treat, "Ki67.+\\(%\\) "),
        ki67 = as.numeric(ki67)/100,
        # ki67 = binomial()$linkfun(ki67)
        # ki67 = log(ki67)
    ) %>%
    ggplot(
        aes(treat, ki67)
    ) +
    geom_violin(
        draw_quantiles = 0.5,
        trim = FALSE
    ) +
    geom_jitter(width = 0.05) +
    scale_y_continuous(limits = c(0, 1), labels = percent)
```


```{r summary_ki67}
ki67_natmed %>%
  dplyr::select(`Sample ID`, contains("Ki67")) %>%
  pivot_longer(
    cols = contains("E2"),
    names_to = "treat",
    values_to = "ki67"
  ) %>%
  mutate(
    treat = str_remove_all(treat, "Ki67.+\\(%\\) "),
    ki67 = as.numeric(ki67)/100
  ) %>%
  group_by(
    treat
  ) %>%
  summarise(
    n = n(),
    across(.cols = contains("ki67"), .fns = list(mean = mean, median = median, sd = sd)),
    .groups = "drop"
  ) %>%
  rename_all(str_replace_all, pattern = "_", replacement = " ") %>%
  rename_all(str_to_title) %>%
  pander(
    caption = "Summary statistics from PDX Ki67 data"
  )
```

Given the above plot, a truncated normal distribution may be suitable for simulation of data.
Note that we'll be using the Wilcoxon, so the exact distributional patterns are less relevant.
Compare some simulated data to the real data.
